<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆè¤‡é›‘ãƒ’ãƒƒãƒˆå½¢å¼å¯¾å¿œï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>ãƒ’ãƒƒãƒˆç¯„å›²ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ1ä¸‡å›ï¼‰</h2>

  <h3>ğŸ“˜ å…¥åŠ›å½¢å¼ã‚¬ã‚¤ãƒ‰</h3>
  <ul>
    <li><strong>ãƒ’ãƒƒãƒˆè¡Œ:</strong> <code>ãƒ’ãƒƒãƒˆ1</code>ã€<code>ãƒ’ãƒƒãƒˆ3-5</code>ã€<code>ãƒ’ãƒƒãƒˆ1-3, 5, 7-8</code> ã®ã‚ˆã†ã«è¨˜è¿°</li>
    <li><strong>é€šå¸¸ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong> æ¬¡ã®è¡Œã« <code>11,000 - 13,000</code> ã®ã‚ˆã†ã«ã€Œä¸‹é™ - ä¸Šé™ã€ã§è¨˜è¿°</li>
    <li><strong>ä¼šå¿ƒãƒ€ãƒ¡ãƒ¼ã‚¸:</strong> ã€Œ<code>ä¼šå¿ƒ</code>ã€ã¨æ›¸ã„ãŸè¡Œã®æ¬¡ã«ã€ä¼šå¿ƒæ™‚ãƒ€ãƒ¡ãƒ¼ã‚¸ã®ãƒ¬ãƒ³ã‚¸ã‚’åŒæ§˜ã«è¨˜è¿°</li>
    <li><strong>æ³¨æ„:</strong> <code>(99.13%)</code> ãªã©ã® % è¡¨ç¤ºã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚å…¥åŠ›ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚</li>
  </ul>
  <pre>
ä¾‹:
ãƒ’ãƒƒãƒˆ1-3, 5, 7
10,000 - 12,000
ä¼šå¿ƒ
20,000 - 24,000
  </pre>
  <p><em>â€» èª­ã¿å–ã‚Œãªã„ä¾‹ãŒã‚ã‚‹å ´åˆã¯ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚</em></p>

  <label>ä¼šå¿ƒç¢ºç‡ (%): <input type="text" id="critRateInput" placeholder="45.43"></label><br><br>

  <textarea id="inputText" rows="16" cols="60">
ãƒ’ãƒƒãƒˆ1-3, 5-6, 8, 10, 12
283 - 371
ä¼šå¿ƒ
482 - 631
ãƒ’ãƒƒãƒˆ4, 7, 9, 11
284 - 372
ä¼šå¿ƒ
482 - 632
  </textarea><br>

  <button onclick="simulate()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹</button>
  <p id="parsedData"></p>
  <p id="result"></p>
  <canvas id="histogramChart" width="800" height="400"></canvas>

  <script>
    let chartInstance = null;

    function parseRange(line) {
      const match = line.match(/([\d,]+)\s*-\s*([\d,]+)/);
      if (!match) return null;
      const low = parseInt(match[1].replace(/,/g, ''));
      const high = parseInt(match[2].replace(/,/g, ''));
      return [low, high];
    }

    function randomIntInRange(low, high) {
      return Math.floor(Math.random() * (high - low + 1)) + low;
    }

    function simulate() {
      const critRateInput = document.getElementById("critRateInput").value.trim();
      const critRate = parseFloat(critRateInput) / 100 || 0.4543;

      const input = document.getElementById("inputText").value;
      const lines = input.split('\n').map(line => line.trim()).filter(line => line.length > 0);

      let hitBlocks = [];
      let debugInfo = `<strong>ä¼šå¿ƒç¢ºç‡: ${(critRate * 100).toFixed(2)}%</strong><br><br><strong>èª­ã¿å–ã£ãŸãƒ–ãƒ­ãƒƒã‚¯æƒ…å ±:</strong><br>`;

      let i = 0;
      while (i < lines.length) {
        if (lines[i].startsWith("ãƒ’ãƒƒãƒˆ")) {
          const hitLine = lines[i];
          const match = hitLine.match(/^ãƒ’ãƒƒãƒˆ(.+)/); // ä¿®æ­£æ¸ˆã¿ï¼šå…¨ä½“ã‚’å–ã‚Šå‡ºã™
          if (!match) {
            i++;
            continue;
          }

          const hitSpec = match[1];  // ä¾‹: "1-3, 5-6, 8"
          const hitNumbers = [];

          hitSpec.split(',').forEach(part => {
            const trimmed = part.trim();
            if (trimmed.includes('-')) {
              const [start, end] = trimmed.split('-').map(n => parseInt(n));
              for (let k = start; k <= end; k++) hitNumbers.push(k);
            } else {
              hitNumbers.push(parseInt(trimmed));
            }
          });

          const hits = hitNumbers.length;

          const [low1, high1] = parseRange(lines[i + 1]);

          let critIndex = i + 2;
          while (critIndex < lines.length && lines[critIndex] !== "ä¼šå¿ƒ") critIndex++;
          const [low2, high2] = parseRange(lines[critIndex + 1]);

          hitBlocks.push({
            hits: hits,
            normal: [low1, high1],
            crit: [low2, high2]
          });

          debugInfo += `ã€ãƒ’ãƒƒãƒˆ${hitSpec}ã€‘ ãƒ’ãƒƒãƒˆæ•°: ${hits}<br>`;
          debugInfo += `ã€€é€šå¸¸ãƒ€ãƒ¡ãƒ¼ã‚¸: ${low1.toLocaleString()} - ${high1.toLocaleString()}<br>`;
          debugInfo += `ã€€ä¼šå¿ƒãƒ€ãƒ¡ãƒ¼ã‚¸: ${low2.toLocaleString()} - ${high2.toLocaleString()}<br><br>`;

          i = critIndex + 2;
        } else {
          i++;
        }
      }

      const trialCount = 10000;
      let totalDamages = [];

      for (let t = 0; t < trialCount; t++) {
        let total = 0;
        for (const block of hitBlocks) {
          for (let j = 0; j < block.hits; j++) {
            const isCrit = Math.random() < critRate;
            const [low, high] = isCrit ? block.crit : block.normal;
            total += randomIntInRange(low, high);
          }
        }
        totalDamages.push(total);
      }

      totalDamages.sort((a, b) => b - a);
      const thresholds = [1, 2, 3, 4, 5, 10, 15, 20, 30, 40, 50];
      let output = `<strong>è©¦è¡Œå›æ•°: ${trialCount.toLocaleString()}</strong><br><br>`;
      output += `<strong>ä¸Šä½x%ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã—ãã„å€¤</strong><br>`;
      for (const x of thresholds) {
        const index = Math.floor(trialCount * (x / 100)) - 1;
        const dmg = totalDamages[index];
        output += `ä¸Šä½ ${x}%: ${dmg.toLocaleString()}<br>`;
      }

      document.getElementById("parsedData").innerHTML = debugInfo;
      document.getElementById("result").innerHTML = output;

      const min = Math.min(...totalDamages);
      const max = Math.max(...totalDamages);
      const binCount = 50;
      const binSize = Math.ceil((max - min + 1) / binCount);
      const bins = new Array(binCount).fill(0);
      for (const dmg of totalDamages) {
        const index = Math.min(Math.floor((dmg - min) / binSize), binCount - 1);
        bins[index]++;
      }

      const labels = [];
      for (let i = 0; i < binCount; i++) {
        const start = min + i * binSize;
        const end = start + binSize - 1;
        labels.push(`${start.toLocaleString()}-${end.toLocaleString()}`);
      }

      const ctx = document.getElementById('histogramChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'ãƒ€ãƒ¡ãƒ¼ã‚¸é »åº¦',
            data: bins
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              ticks: { autoSkip: true, maxTicksLimit: 20, minRotation: 45 },
              title: { display: true, text: 'åˆè¨ˆãƒ€ãƒ¡ãƒ¼ã‚¸ç¯„å›²' }
            },
            y: {
              title: { display: true, text: 'é »åº¦' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (tooltipItems) => `ç¯„å›²: ${tooltipItems[0].label}`,
                label: (tooltipItem) => `ä»¶æ•°: ${tooltipItem.raw}`
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
