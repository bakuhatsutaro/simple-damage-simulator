<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç°¡å˜ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; }
    #guide { background: #f0f8ff; padding: 1em; border: 1px solid #ccc; margin-bottom: 1em; }
    #error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ1ä¸‡å›ï¼‰</h2>

  <div id="guide">
    <h3>ğŸ“˜ å…¥åŠ›å½¢å¼ã‚¬ã‚¤ãƒ‰</h3>
    <ul>
      <li><strong>ãƒ’ãƒƒãƒˆè¡Œ:</strong> <code>ãƒ’ãƒƒãƒˆ1-3, 5, 7-8</code> ã®ã‚ˆã†ã«è¨˜è¼‰ã€‚ã“ã“ã®èª­ã¿å–ã‚Šå¤±æ•—ãŒèµ·ã“ã‚Šã‚„ã™ã„ã®ã§ã€ä¸è¦å‰‡ãªãƒ’ãƒƒãƒˆã‚’ã—ã¦ã„ãŸã¨ã—ã¦ã‚‚ã€å¤šå°‘å˜˜ã¤ã„ã¦ãƒ’ãƒƒãƒˆ1-8ã®ã‚ˆã†ãªå˜ç´”ãªæ›¸ãæ–¹ã«å¤‰ãˆã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™</li>
      <li><strong>é€šå¸¸ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong> æ¬¡ã®è¡Œã« <code>11,000 - 13,000</code> ã®ã‚ˆã†ã«è¨˜è¼‰</li>
      <li><strong>ä¼šå¿ƒãƒ€ãƒ¡ãƒ¼ã‚¸:</strong> ã€Œ<code>ä¼šå¿ƒ</code>ã€ã®æ¬¡ã®è¡Œã«åŒæ§˜ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã®ç¯„å›²ã‚’è¨˜è¼‰</li>
      <li><code>(99.13%)</code> ãªã©ã® % è¡¨ç¤ºã¯ä½¿ã„ã¾ã›ã‚“ã®ã§ç„¡è¦–ã•ã‚Œã¾ã™</li>
    </ul>
    <pre>
ä¾‹:
ãƒ’ãƒƒãƒˆ1-3, 5, 7
10,000 - 12,000
ä¼šå¿ƒ
20,000 - 24,000
    </pre>
    <p>èª­ã¿å–ã£ã¦ãã‚Œãªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Œã°ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚</p>
  </div>

  <label>ä¼šå¿ƒç¢ºç‡ (%): <input type="text" id="critRateInput" placeholder="45.43"></label><br><br>

  <textarea id="inputText" rows="12" cols="60">
ãƒ’ãƒƒãƒˆ1-3, 5-6, 8, 10, 12
283 - 371
ä¼šå¿ƒ
482 - 631
ãƒ’ãƒƒãƒˆ4, 7, 9, 11
284 - 372
ä¼šå¿ƒ
482 - 632
  </textarea><br>

  <button onclick="simulate()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹</button>
  <p id="parsedData"></p>
  <p id="result"></p>
  <div id="error"></div>
  <canvas id="histogramChart" width="800" height="400"></canvas>

  <script>
    let chartInstance = null;

    function parseRange(line) {
      const match = line.match(/([\d,]+)\s*-\s*([\d,]+)/);
      if (!match) return null;
      const low = parseInt(match[1].replace(/,/g, ''));
      const high = parseInt(match[2].replace(/,/g, ''));
      if (isNaN(low) || isNaN(high)) return null;
      return [low, high];
    }

    function randomIntInRange(low, high) {
      return Math.floor(Math.random() * (high - low + 1)) + low;
    }

    function simulate() {
      document.getElementById("error").innerHTML = "";
      const critRateInput = document.getElementById("critRateInput").value.trim();
      const critRate = parseFloat(critRateInput) / 100 || 0.4543;

      const input = document.getElementById("inputText").value;
      const lines = input.split('\n').map(line => line.trim()).filter(line => line.length > 0);

      let hitBlocks = [];
      let debugInfo = `<strong>ä¼šå¿ƒç¢ºç‡: ${(critRate * 100).toFixed(2)}%</strong><br><br><strong>èª­ã¿å–ã£ãŸãƒ–ãƒ­ãƒƒã‚¯æƒ…å ±:</strong><br>`;
      let errorMessages = [];

      let i = 0;
      while (i < lines.length) {
        if (lines[i].startsWith("ãƒ’ãƒƒãƒˆ")) {
          const hitLine = lines[i];
          const rawSpec = hitLine.replace(/^ãƒ’ãƒƒãƒˆ/, '').replace(/,/g, ' ');
          const parts = rawSpec.split(/\s+/);
          const hitNumbers = [];
          let valid = true;

          for (const part of parts) {
            const trimmed = part.trim();
            if (/^\d+-\d+$/.test(trimmed)) {
              const [start, end] = trimmed.split('-').map(Number);
              if (start > end || isNaN(start) || isNaN(end)) {
                valid = false;
                break;
              }
              for (let k = start; k <= end; k++) hitNumbers.push(k);
            } else if (/^\d+$/.test(trimmed)) {
              hitNumbers.push(Number(trimmed));
            } else {
              valid = false;
              break;
            }
          }

          if (!valid || hitNumbers.length === 0) {
            errorMessages.push(`âŒ ãƒ’ãƒƒãƒˆç•ªå·ãŒè§£æã§ãã¾ã›ã‚“ã§ã—ãŸ: "${rawSpec}"`);
            i++;
            continue;
          }

          const hits = hitNumbers.length;

          const parsedNormal = parseRange(lines[i + 1]);
          if (!parsedNormal) {
            errorMessages.push(`âŒ é€šå¸¸ãƒ€ãƒ¡ãƒ¼ã‚¸ç¯„å›²ãŒä¸æ­£ã¾ãŸã¯æ¬ æã—ã¦ã„ã¾ã™ï¼ˆãƒ’ãƒƒãƒˆ${rawSpec}ï¼‰: "${lines[i + 1]}"`);
            i++;
            continue;
          }
          const [low1, high1] = parsedNormal;

          let critIndex = i + 2;
          while (critIndex < lines.length && lines[critIndex] !== "ä¼šå¿ƒ") critIndex++;
          if (critIndex + 1 >= lines.length) {
            errorMessages.push(`âŒ ä¼šå¿ƒãƒ€ãƒ¡ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ’ãƒƒãƒˆ${rawSpec}ï¼‰`);
            i++;
            continue;
          }

          const parsedCrit = parseRange(lines[critIndex + 1]);
          if (!parsedCrit) {
            errorMessages.push(`âŒ ä¼šå¿ƒãƒ€ãƒ¡ãƒ¼ã‚¸ç¯„å›²ãŒä¸æ­£ã¾ãŸã¯æ¬ æã—ã¦ã„ã¾ã™ï¼ˆãƒ’ãƒƒãƒˆ${rawSpec}ï¼‰: "${lines[critIndex + 1]}"`);
            i++;
            continue;
          }
          const [low2, high2] = parsedCrit;

          hitBlocks.push({ hits: hits, normal: [low1, high1], crit: [low2, high2] });
          debugInfo += `ã€ãƒ’ãƒƒãƒˆ${rawSpec}ã€‘ ãƒ’ãƒƒãƒˆæ•°: ${hits}<br>`;
          debugInfo += `ã€€é€šå¸¸ãƒ€ãƒ¡ãƒ¼ã‚¸: ${low1.toLocaleString()} - ${high1.toLocaleString()}<br>`;
          debugInfo += `ã€€ä¼šå¿ƒãƒ€ãƒ¡ãƒ¼ã‚¸: ${low2.toLocaleString()} - ${high2.toLocaleString()}<br><br>`;

          i = critIndex + 2;
        } else {
          i++;
        }
      }

      if (hitBlocks.length === 0) {
        document.getElementById("parsedData").innerHTML = "";
        document.getElementById("result").innerHTML = "";
        document.getElementById("error").innerHTML = errorMessages.join("<br>");
        return;
      }

      const trialCount = 10000;
      let totalDamages = [];

      for (let t = 0; t < trialCount; t++) {
        let total = 0;
        for (const block of hitBlocks) {
          for (let j = 0; j < block.hits; j++) {
            const isCrit = Math.random() < critRate;
            const [low, high] = isCrit ? block.crit : block.normal;
            total += randomIntInRange(low, high);
          }
        }
        totalDamages.push(total);
      }

    // 1. ã‚½ãƒ¼ãƒˆï¼ˆå¤§ãã„é †ï¼‰
    totalDamages.sort((a, b) => b - a);

    // 2. 0.5%åˆ»ã¿ã§1-F(x)è¨ˆç®—ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ç‚¹ã‚’å–å¾—ï¼‰
    const points = [];
    for (let p = 0; p <= 100; p += 0.5) {
      if (p === 100) continue; // 100%ç‚¹ã¯ä¸è¦
      const index = Math.floor(totalDamages.length * (p / 100));
      const threshold = totalDamages[index];
      const prob = 1 - p / 100;
      points.push({ x: threshold, y: prob });
    }

    // 3. æ¨ªè»¸ã‚’å¤§ãã„â†’å°ã•ã„ã«ã™ã‚‹ãŸã‚é…åˆ—ã¯ãã®ã¾ã¾ä½¿ã†ï¼ˆx:ã—ãã„å€¤ã€y:ãã‚Œä»¥ä¸Šã®ç¢ºç‡ï¼‰

    // 4. Chart.jsã§scatteræç”»ï¼ˆç·šãªã—ãƒ»ç‚¹ã®ã¿ï¼‰
    const ctx = document.getElementById('histogramChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [{
          label: '1-F(x): xä»¥ä¸Šã¨ãªã‚‹ç¢ºç‡',
          data: points,
          showLine: true,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            title: { display: true, text: 'åˆè¨ˆãƒ€ãƒ¡ãƒ¼ã‚¸' },
            // æ¨ªè»¸ã‚’ã€Œå¤§â†’å°ã€ã§é€†å‘ãã«ã™ã‚‹
            reverse: true
          },
          y: {
            title: { display: true, text: 'xä»¥ä¸Šã®ç¢ºç‡ï¼ˆ1-F(x))' },
            min: 0,
            max: 1
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: (item) => `ãƒ€ãƒ¡ãƒ¼ã‚¸: ${item.parsed.x}, ç¢ºç‡: ${(item.parsed.y * 100).toFixed(2)}%`
            }
          }
        }
      }
    });
  }
</script>
</body>
</html>
